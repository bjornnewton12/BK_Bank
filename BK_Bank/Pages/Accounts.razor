@page "/accounts"
@inject IAccountService AccountService
@inject IAuthenticationService AuthenticationService
@inject NavigationManager Navigation
@using BK_Bank.Domain

@* 
Summary:
Displays all of the user's bank accounts with details such as type, balance, 
interest rate, and last updated date. Allows removal of accounts with zero balance.
*@

<PageTitle>Accounts</PageTitle>

<h1>Accounts</h1>

@code {
    private CreateAccountModel _model = new();
    private List<BankAccount> _accounts = new();

    // Start value
    private SortKey currentKey = SortKey.Name;
    private bool descending = false;

    //Sorting keys for table
    private enum SortKey
    {
        Name,
        AccountType,
        Balance,
        AccumulatedInterest,
        LastUpdated
    }

    // Check if page is authenticated and load all user accounts when the page initializes
    protected override async Task OnInitializedAsync()
    {
        _accounts = await AccountService.GetAccounts();
    }

    // Create a new account and refresh the list
    private async Task CreateAccountAsync()
    {
        try
        {
            await AccountService.CreateAccount(
            _model.Name!,
            _model.AccountType,
            _model.InitialBalance);

            _accounts = await AccountService.GetAccounts();
            _model.Clear();
        }
        catch (Exception exception)
        {
            Console.WriteLine(exception);
        }
    }

    // Remove an account
    private async Task RemoveAccount(IBankAccount account)
    {
        await AccountService.DeleteAccount(account);
        _accounts = await AccountService.GetAccounts();
        Console.WriteLine("MyAccounts INFO: Removed account");
    }

    // Model for handling new account creation (shared structure)
    private class CreateAccountModel
    {
        public string? Name { get; set; }
        public AccountType AccountType { get; set; }
        public decimal InitialBalance { get; set; } = 0;

        public void Clear()
        {
            Name = string.Empty;
            InitialBalance = 0;
            AccountType = default;
        }
    }

    // Change the current sorting key or reverse sort order
    private void SetSort(SortKey sortKey)
    {
        if (currentKey == sortKey)
        {
            descending = !descending;
        }
        else
        {
            currentKey = sortKey;
            descending = true;
        }
    }

    private IEnumerable<BankAccount> SortedAccounts()
    {
        // Sort list
        var sortedList = _accounts.AsEnumerable();

        sortedList = currentKey switch
        {
            SortKey.Name => (descending ? sortedList.OrderByDescending(t => t.Name)
            : sortedList.OrderBy(t => t.Name)),
            SortKey.Balance => (descending ? sortedList.OrderByDescending(t => t.Balance)
            : sortedList.OrderBy(t => t.Balance)),
            SortKey.AccumulatedInterest => (descending ? sortedList.OrderByDescending(t => t.ApplyInterest())
            : sortedList.OrderBy(t => t.ApplyInterest())),
            SortKey.LastUpdated => (descending ? sortedList.OrderByDescending(t => t.LastUpdated)
            : sortedList.OrderBy(t => t.LastUpdated)),

            _ => sortedList
        };
        return sortedList;
    }
}
